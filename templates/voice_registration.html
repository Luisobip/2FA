{% extends "base.html" %}

{% block title %}Registro de Voz{% endblock %}

{% block extra_head %}
<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
<style>
    .waveform {
        width: 100%;
        max-width: 600px;
        height: 150px;
        background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
        border-radius: 15px;
        margin: 20px auto;
        position: relative;
        overflow: hidden;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    }

    .waveform canvas {
        width: 100%;
        height: 100%;
    }

    .challenge-box {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 30px;
        border-radius: 15px;
        color: white;
        text-align: center;
        margin: 20px auto;
        max-width: 600px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    }

    .challenge-text {
        font-size: 32px;
        font-weight: bold;
        letter-spacing: 3px;
        margin: 20px 0;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
    }

    .progress-tracker {
        display: flex;
        justify-content: center;
        gap: 15px;
        margin: 30px 0;
    }

    .sample-indicator {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: #e0e0e0;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 24px;
        transition: all 0.3s;
    }

    .sample-indicator.completed {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        transform: scale(1.1);
    }

    .sample-indicator.current {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        color: white;
        animation: pulse-ring 1.5s infinite;
    }

    @keyframes pulse-ring {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.15); }
    }

    .status-indicator {
        display: inline-block;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        margin-right: 10px;
        animation: pulse 2s infinite;
    }

    .status-indicator.recording {
        background: #ff0000;
    }

    .status-indicator.processing {
        background: #ffaa00;
    }

    .status-indicator.ready {
        background: #00ff00;
    }

    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }

    .countdown {
        font-size: 48px;
        font-weight: bold;
        color: #667eea;
        margin: 20px 0;
    }

    #recordBtn {
        font-size: 18px;
        padding: 20px 40px;
    }
</style>
{% endblock %}

{% block content %}
<div class="logo">üéôÔ∏è</div>
<h1>Registro de Voz</h1>
<p style="text-align: center; color: #666; margin-bottom: 20px;">
    Usuario: <strong>{{ username }}</strong>
</p>

<div class="info" id="instructions">
    <strong>Configuraci√≥n de Verificaci√≥n de Voz:</strong><br>
    1. Grabar√°s <strong>5 muestras</strong> con frases diferentes<br>
    2. Cada grabaci√≥n dura 6 segundos<br>
    3. <strong>Habla despacio, con claridad y volumen normal</strong><br>
    4. Ambiente silencioso recomendado<br>
    5. Esto crear√° tu perfil de voz √∫nico
</div>

<div class="progress-tracker" id="progressTracker">
    <div class="sample-indicator current" id="sample1">1</div>
    <div class="sample-indicator" id="sample2">2</div>
    <div class="sample-indicator" id="sample3">3</div>
    <div class="sample-indicator" id="sample4">4</div>
    <div class="sample-indicator" id="sample5">5</div>
</div>

<div class="challenge-box" id="challengeBox" style="display: none;">
    <h3 style="margin: 0;">Di esta frase:</h3>
    <div class="challenge-text" id="challengeText">{{ challenge_phrase }}</div>
    <p style="margin-top: 20px; opacity: 0.9;">Muestra <span id="currentSample">1</span> de 5</p>
</div>

<div class="waveform" id="waveformContainer" style="display: none;">
    <canvas id="waveformCanvas"></canvas>
</div>

<div id="statusMessage" style="text-align: center; margin: 20px 0; font-size: 18px; min-height: 30px;"></div>

<div id="countdown" class="countdown" style="display: none;"></div>

<button id="recordBtn" class="btn">
    üéôÔ∏è Comenzar Registro
</button>

<div class="link">
    <a href="{{ url_for('setup_biometrics') }}">‚Üê Volver</a>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    const socket = io();
    const recordBtn = document.getElementById('recordBtn');
    const statusMessage = document.getElementById('statusMessage');
    const challengeBox = document.getElementById('challengeBox');
    const waveformContainer = document.getElementById('waveformContainer');
    const waveformCanvas = document.getElementById('waveformCanvas');
    const ctx = waveformCanvas.getContext('2d');
    const countdown = document.getElementById('countdown');
    const challengeText = document.getElementById('challengeText');
    const currentSampleSpan = document.getElementById('currentSample');

    let mediaRecorder;
    let audioChunks = [];
    let audioContext;
    let analyser;
    let dataArray;
    let animationId;
    let currentSample = 0;
    let samples = [];

    // Configurar canvas
    waveformCanvas.width = waveformCanvas.offsetWidth * 2;
    waveformCanvas.height = waveformCanvas.offsetHeight * 2;

    function updateProgressTracker() {
        for (let i = 1; i <= 5; i++) {
            const indicator = document.getElementById(`sample${i}`);
            indicator.classList.remove('current', 'completed');

            if (i < currentSample) {
                indicator.classList.add('completed');
            } else if (i === currentSample) {
                indicator.classList.add('current');
            }
        }
    }

    function drawWaveform() {
        if (!analyser) return;

        animationId = requestAnimationFrame(drawWaveform);

        analyser.getByteTimeDomainData(dataArray);

        ctx.fillStyle = 'rgba(30, 60, 114, 0.1)';
        ctx.fillRect(0, 0, waveformCanvas.width, waveformCanvas.height);

        ctx.lineWidth = 4;
        ctx.strokeStyle = '#00ff88';
        ctx.beginPath();

        const sliceWidth = waveformCanvas.width / dataArray.length;
        let x = 0;

        for (let i = 0; i < dataArray.length; i++) {
            const v = dataArray[i] / 128.0;
            const y = v * waveformCanvas.height / 2;

            if (i === 0) {
                ctx.moveTo(x, y);
            } else {
                ctx.lineTo(x, y);
            }

            x += sliceWidth;
        }

        ctx.lineTo(waveformCanvas.width, waveformCanvas.height / 2);
        ctx.stroke();
    }

    async function recordSample(challengePhrase) {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });

            // Configurar visualizaci√≥n
            audioContext = new AudioContext();
            const source = audioContext.createMediaStreamSource(stream);
            analyser = audioContext.createAnalyser();
            analyser.fftSize = 2048;
            source.connect(analyser);
            dataArray = new Uint8Array(analyser.frequencyBinCount);

            // Configurar MediaRecorder
            mediaRecorder = new MediaRecorder(stream, {
                mimeType: 'audio/webm;codecs=opus'
            });

            audioChunks = [];

            mediaRecorder.ondataavailable = (event) => {
                if (event.data.size > 0) {
                    audioChunks.push(event.data);
                }
            };

            mediaRecorder.onstop = async () => {
                const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });

                // Convertir a base64
                const reader = new FileReader();
                reader.onloadend = () => {
                    const base64Audio = reader.result;
                    statusMessage.innerHTML = '<span class="status-indicator processing"></span>Procesando muestra...';

                    samples.push({
                        audio: base64Audio,
                        challenge: challengePhrase
                    });

                    // Indicar muestra completada
                    document.getElementById(`sample${currentSample}`).classList.remove('current');
                    document.getElementById(`sample${currentSample}`).classList.add('completed');

                    currentSample++;

                    if (currentSample <= 5) {
                        // Solicitar siguiente frase
                        setTimeout(() => {
                            socket.emit('request_challenge');
                        }, 1000);
                    } else {
                        // Enviar todas las muestras
                        statusMessage.innerHTML = '<span class="status-indicator processing"></span>Guardando perfil de voz...';
                        socket.emit('register_voice', { samples: samples });
                    }
                };
                reader.readAsDataURL(audioBlob);

                // Detener visualizaci√≥n
                if (animationId) {
                    cancelAnimationFrame(animationId);
                }
                stream.getTracks().forEach(track => track.stop());
            };

            // Mostrar elementos
            challengeBox.style.display = 'block';
            challengeText.textContent = challengePhrase;
            currentSampleSpan.textContent = currentSample;
            waveformContainer.style.display = 'block';
            recordBtn.style.display = 'none';

            // Countdown
            statusMessage.innerHTML = '<span class="status-indicator ready"></span>Preparando...';
            countdown.style.display = 'block';

            for (let i = 3; i > 0; i--) {
                countdown.textContent = i;
                await new Promise(resolve => setTimeout(resolve, 1000));
            }

            countdown.style.display = 'none';

            // Iniciar grabaci√≥n
            mediaRecorder.start();
            statusMessage.innerHTML = `<span class="status-indicator recording"></span>¬°Habla AHORA! (6 segundos) - Muestra ${currentSample}/5`;
            drawWaveform();

            // Detener despu√©s de 6 segundos
            setTimeout(() => {
                if (mediaRecorder && mediaRecorder.state === 'recording') {
                    mediaRecorder.stop();
                }
            }, 6000);

        } catch (err) {
            console.error('Error al acceder al micr√≥fono:', err);
            statusMessage.innerHTML = '‚ùå Error: No se pudo acceder al micr√≥fono';
            statusMessage.style.color = '#ff0000';
            recordBtn.style.display = 'block';
        }
    }

    recordBtn.addEventListener('click', () => {
        currentSample = 1;
        samples = [];
        updateProgressTracker();
        socket.emit('request_challenge');
    });

    // Recibir nueva frase de desaf√≠o
    socket.on('new_challenge', (data) => {
        statusMessage.innerHTML = '<span class="status-indicator ready"></span>Nueva frase generada';
        setTimeout(() => {
            recordSample(data.challenge);
        }, 500);
    });

    // Registro completado
    socket.on('voice_registration_complete', (data) => {
        if (data.success) {
            statusMessage.innerHTML = '‚úÖ ¬°Perfil de voz registrado exitosamente!';
            statusMessage.style.color = '#00ff00';
            challengeBox.style.display = 'none';
            waveformContainer.style.display = 'none';

            // Marcar √∫ltima muestra como completada
            document.getElementById('sample5').classList.add('completed');

            setTimeout(() => {
                window.location.href = "{{ url_for('setup_biometrics') }}";
            }, 2000);
        } else {
            statusMessage.innerHTML = '‚ùå Error al registrar voz';
            statusMessage.style.color = '#ff0000';
            recordBtn.style.display = 'block';
        }
    });

    socket.on('voice_error', (data) => {
        console.error('Error:', data);
        statusMessage.innerHTML = '‚ùå Error: ' + data.error;
        statusMessage.style.color = '#ff0000';
        recordBtn.style.display = 'block';
        challengeBox.style.display = 'none';
        waveformContainer.style.display = 'none';
    });
</script>
{% endblock %}
