{% extends "base.html" %}

{% block title %}Registro Facial{% endblock %}

{% block extra_head %}
<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
<style>
    .video-container {
        position: relative;
        max-width: 640px;
        margin: 20px auto;
    }

    #video {
        width: 100%;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    }

    canvas {
        display: none;
    }

    #faceBox {
        position: absolute;
        border: 3px solid #ffaa00;
        border-radius: 10px;
        display: none;
    }

    #statusMessage {
        position: absolute;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 15px 30px;
        border-radius: 10px;
        font-weight: 600;
        font-size: 18px;
        white-space: nowrap;
    }

    #captureBtn {
        display: none;
    }
</style>
{% endblock %}

{% block content %}
<div class="logo">üì∏</div>
<h1>Registro Facial</h1>
<p style="text-align: center; color: #666; margin-bottom: 20px;">
    Usuario: <strong>{{ username }}</strong>
</p>

<div class="info" id="instructions">
    <strong>Instrucciones:</strong><br>
    1. Permite el acceso a tu c√°mara<br>
    2. Coloca tu rostro frente a la c√°mara<br>
    3. Mant√©n tu rostro dentro del recuadro<br>
    4. Haz clic en "Capturar" cuando est√© listo
</div>

<div class="video-container">
    <video id="video" autoplay playsinline></video>
    <canvas id="canvas"></canvas>
    <div id="faceBox"></div>
    <div id="statusMessage">Inicializando c√°mara...</div>
</div>

<button id="captureBtn" class="btn btn-success">
    üì∏ Capturar Rostro
</button>

<div class="link">
    <a href="{{ url_for('setup_biometrics') }}">‚Üê Volver</a>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    const socket = io();
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const faceBox = document.getElementById('faceBox');
    const statusMessage = document.getElementById('statusMessage');
    const captureBtn = document.getElementById('captureBtn');

    let streaming = false;
    let frameInterval;
    let faceDetected = false;
    let faceReady = false;

    // Acceder a la c√°mara
    navigator.mediaDevices.getUserMedia({
        video: {
            width: { ideal: 640 },
            height: { ideal: 480 },
            facingMode: 'user'
        }
    })
    .then(stream => {
        video.srcObject = stream;
        video.onloadedmetadata = () => {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            statusMessage.textContent = 'Coloca tu rostro frente a la c√°mara';
            startStreaming();
        };
    })
    .catch(err => {
        console.error('Error al acceder a la c√°mara:', err);
        statusMessage.textContent = 'Error: No se pudo acceder a la c√°mara';
        statusMessage.style.background = 'rgba(255, 0, 0, 0.8)';
    });

    function startStreaming() {
        if (streaming) return;
        streaming = true;

        // Enviar frames cada 150ms
        frameInterval = setInterval(() => {
            if (video.readyState === video.HAVE_ENOUGH_DATA) {
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                const imageData = canvas.toDataURL('image/jpeg', 0.8);
                socket.emit('register_frame', { image: imageData });
            }
        }, 150);
    }

    function stopStreaming() {
        streaming = false;
        if (frameInterval) {
            clearInterval(frameInterval);
        }
        if (video.srcObject) {
            video.srcObject.getTracks().forEach(track => track.stop());
        }
    }

    // Recibir detecci√≥n de rostro
    socket.on('face_detected', (data) => {
        if (data.detected) {
            faceDetected = true;
            faceReady = data.ready || false;

            const videoRect = video.getBoundingClientRect();
            const scaleX = videoRect.width / canvas.width;
            const scaleY = videoRect.height / canvas.height;

            faceBox.style.display = 'block';
            faceBox.style.left = (data.box.x1 * scaleX) + 'px';
            faceBox.style.top = (data.box.y1 * scaleY) + 'px';
            faceBox.style.width = ((data.box.x2 - data.box.x1) * scaleX) + 'px';
            faceBox.style.height = ((data.box.y2 - data.box.y1) * scaleY) + 'px';

            if (faceReady) {
                faceBox.style.borderColor = '#00ff00';
                statusMessage.textContent = '‚úì Listo! Haz clic en "Capturar"';
                statusMessage.style.background = 'rgba(0, 255, 0, 0.8)';
                captureBtn.style.display = 'block';
            } else {
                faceBox.style.borderColor = '#ffaa00';
                statusMessage.textContent = 'Rostro detectado - Estabilizando...';
                statusMessage.style.background = 'rgba(255, 170, 0, 0.8)';
                captureBtn.style.display = 'none';
            }
        } else {
            faceDetected = false;
            faceReady = false;
            faceBox.style.display = 'none';
            statusMessage.textContent = 'Coloca tu rostro frente a la c√°mara';
            statusMessage.style.background = 'rgba(0, 0, 0, 0.8)';
            captureBtn.style.display = 'none';
        }
    });

    // Capturar rostro
    captureBtn.addEventListener('click', () => {
        if (!faceReady) return;

        captureBtn.disabled = true;
        captureBtn.textContent = 'Procesando...';
        statusMessage.textContent = 'Capturando y procesando...';

        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        const imageData = canvas.toDataURL('image/jpeg', 0.95);
        socket.emit('capture_face', { image: imageData });
    });

    // Registro completo
    socket.on('registration_complete', (data) => {
        if (data.success) {
            statusMessage.textContent = '‚úì ¬°Rostro registrado exitosamente!';
            statusMessage.style.background = 'rgba(0, 255, 0, 0.8)';
            captureBtn.textContent = '‚úì Completado';

            stopStreaming();

            // Redirigir
            setTimeout(() => {
                window.location.href = "{{ url_for('setup_biometrics') }}";
            }, 2000);
        }
    });

    // Error de registro
    socket.on('registration_error', (data) => {
        console.error('Error:', data);
        statusMessage.textContent = '‚úó Error: ' + data.error;
        statusMessage.style.background = 'rgba(255, 0, 0, 0.8)';
        captureBtn.disabled = false;
        captureBtn.textContent = 'üì∏ Capturar Rostro';
    });

    // Limpiar al salir
    window.addEventListener('beforeunload', stopStreaming);
</script>
{% endblock %}
